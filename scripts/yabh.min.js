//=============================================================================
// yabh.src.js
//
// Código completo do jogo todo encapsulado numa função e compactado. Agora tá
// perfeito pra usar.
//=============================================================================
"use strict";!function(){function t(t,e,i,n){if(!t||"string"!=typeof t)throw new Error("Nome inválido para a classe");if(!i||"object"!=typeof i)throw new Error("Protótipo inválido para a classe");if(window[t]=function(){this.initialize.apply(this,arguments)},e){if("string"!=typeof e)throw new Error("Tipo inválido para `super'");if("function"!=typeof window[e])throw new Error("`"+e+"' não é uma classe");window[t].prototype=Object.create(window[e].prototype),window[t].prototype.__super__=window[e].prototype,window[t].prototype.constructor=window[t];for(var o in i)window[t].prototype[o]=i[o]}else window[t].prototype=i;if(n){if("object"!=typeof n)throw new Error("Propriedades inválidas");Object.defineProperties(window[t].prototype,n)}}function e(t,e,i){if(typeof t!=e)throw new Error("Tipo inválido para `"+i+"'")}function i(t,e,i){if("object"!=typeof t||!(t instanceof e))throw new Error("Tipo inválido para `"+i+"'")}function n(){this.dispose();for(var t=0;54>=t;t++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(4,2*Math.PI/54*t)]),this)}function o(){r.update(),h.update(),requestAnimationFrame(o)}Number.prototype.between=function(t,i){e(t,"number","a"),e(i,"number","b");var n=t>i?t:i,o=i>t?t:i;return this>=o&&n>=this},Object.prototype.clone=function(){var t=Object.create(this);if(this instanceof Array)for(var e=0;e<this.length;e++)this[e]&&"object"==typeof this[e]?t[e]=this[e].clone():t[e]=this[e];else for(var i in this)this.hasOwnProperty(i)&&(this[i]&&"object"==typeof this[i]?t[i]=this[i].clone():t[i]=this[i]);return t},Array.prototype.contains=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return!0;return!1},Array.prototype.remove=function(t){this.splice(this.indexOf(t),1)};var s={_codes:{shift:16,space:32,left:37,up:38,right:39,down:40,z:90},_keysDown:[],reset:function(){this._keysDown=[]},dir8:function(){var t=this._keysDown.contains(this._codes.left),e=this._keysDown.contains(this._codes.up),i=this._keysDown.contains(this._codes.right),n=this._keysDown.contains(this._codes.down);return t?n?1:e?7:4:i?n?3:e?9:6:e?8:n?2:0},shiftPressed:function(){return this._keysDown.contains(this._codes.shift)},actionPressed:function(){return this._keysDown.contains(this._codes.z)||this._keysDown.contains(this._codes.space)}};document.addEventListener("keydown",function(t){s._keysDown.contains(t.keyCode)||s._keysDown.push(t.keyCode)}),document.addEventListener("keyup",function(t){s._keysDown.remove(t.keyCode)}),window.addEventListener("blur",function(){s._keysDown=[]});var r={_player:null,_objects:[],_stages:[],_movements:{},_actionPatterns:{},_stageID:0,_pause:!1,start:function(){this.clear(),this.createPlayer(),this.setupStage()},update:function(){return this._objects.some(function(t){return t instanceof Enemy})||(this.currentStage.terminate(),this.nextStage(),this.setupStage()),s._keysDown.contains(17)?this.restart():(s._keysDown.contains(27)?this._pause=!0:s.actionPressed()&&(this._pause=!1),void(this._pause||this.forEachObject(function(t){t.update()})))},restart:function(){this.currentStage.terminate(),this.forEachObject(function(t){t.dispose()}),this.clear(),this.start()},clear:function(){this._objects=[]},setupStage:function(){this.currentStage?(h.backgroundColor=this.currentStage.backgroundColor,this.currentStage.initialize()):this.nextStage()},nextStage:function(){this._stageID++,this._checkFinished()},_checkFinished:function(){this._stageID>=this._stages.length&&(this._stageID=0,this.restart())},createPlayer:function(){return this._player=new Player(h.width/2,h.height-32),this.add(this._player),this._player},createMovement:function(t,n,o){return e(t,"string","name"),i(n,Array,"velocities"),this._movements[t]||(this._movements[t]=new Movement(n),o&&(this._movements[t].onUpdate=o)),this._movements[t]},createActionPattern:function(t,i){return e(t,"string","name"),this._actionPatterns[t]=new GameActions(i),this._actionPatterns[t]},createStage:function(t){e(t,"object","obj"),this._stages.push(t)},createEnemy:function(t,e,i,n,o){var s=new Enemy(t,e,i,n,o);return this.add(s),s},createEnemies:function(){for(var t=0;t<arguments.length;t++)i(arguments[t],Array,"arguments["+t+"]"),this.createEnemy.apply(this,arguments[t])},createProjectile:function(t,e,i,n){var o=new Projectile(t,e,i,n);return this.add(o),o},movement:function(t){return e(t,"string","name"),this._movements[t]},actionPattern:function(t){return e(t,"string","name"),this._actionPatterns[t]},add:function(t){i(t,GameObject,"obj"),this._objects.push(t)},remove:function(t){i(t,GameObject,"obj"),this._objects.remove(t)},forEachObject:function(t){for(var e=0;e<this._objects.length;e++)t.call(null,this._objects[e])}};Object.defineProperties(r,{currentStage:{get:function(){return this._stages[this._stageID]}}});var h={initialize:function(){this._canvas=document.createElement("canvas"),this.width=640,this.height=480,this._canvas.id="GameCanvas",this._context=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)},update:function(){this._context.clearRect(0,0,this.width,this.height),r.forEachObject(function(t){var e=t.color.toString(16),i="#"+"000000".substring(0,6-e.length)+e;i!=this._context.fillStyle&&(this._context.fillStyle=i),this._context.fillRect(t.hitbox.left,t.hitbox.top,t.hitbox.width,t.hitbox.height)}.bind(this))}};Object.defineProperties(h,{width:{get:function(){return this._canvas.width},set:function(t){e(t,"number","value"),this._canvas.width=t}},height:{get:function(){return this._canvas.height},set:function(t){e(t,"number","value"),this._canvas.height=t}},backgroundColor:{get:function(){return this._canvas.style.backgroundColor},set:function(t){e(t,"number","value");var i=t.toString(16);this._canvas.style.backgroundColor="#"+"000000".substring(0,6-i.length)}}});var a={_bgmList:["audio/badapple.mp3","audio/tetris.mp3","audio/megalovania.mp3"],initialize:function(){this._bgm=new Audio(this._bgmList[0]),this._bgmNumber=0,this._bgm.addEventListener("ended",function(){this._bgmNumber++,this._bgmNumber%=this._bgmList.length,this._bgm.src=this._bgmList[this._bgmNumber],this._bgm.pause(),this._bgm.load(),this._bgm.play()}.bind(this)),this._bgm.play()}};t("Hitbox",null,{initialize:function(t,i,n,o){if(e(t,"number","x"),e(t,"number","y"),e(t,"number","w"),e(t,"number","h"),0>=n)throw new Error("A largura da hitbox deve ser maior que zero");if(0>=o)throw new Error("A altura da hitbox deve ser maior que zero");this._x=t,this._y=i,this._w=n,this._h=o},collidesWith:function(t){i(t,Hitbox,"other");var e=0;return this.right.between(t.left,t.right)?e++:this.left.between(t.left,t.right)&&e++,this.bottom.between(t.top,t.bottom)?e++:this.top.between(t.top,t.bottom)&&e++,e>1}},{x:{get:function(){return this._x},set:function(t){e(t,"number","value"),this._x=t}},y:{get:function(){return this._y},set:function(t){e(t,"number","value"),this._y=t}},width:{get:function(){return this._w},set:function(t){if(e(t,"number","value"),0>t)throw new Error("A largura deve ser maior que zero");this._w=t,this.x=this._x}},height:{get:function(){return this._h},set:function(t){if(e(t,"number","value"),0>t)throw new Error("A altura deve ser maior que zero");this._h=t,this.y=this._y}},left:{get:function(){return this._x-this._w/2},set:function(t){this.x=t+this._w/2}},right:{get:function(){return this._x+this._w/2},set:function(t){this.x=t-this._w/2}},top:{get:function(){return this._y-this._h/2},set:function(t){this.y=t+this._h/2}},bottom:{get:function(){return this._y+this._h/2},set:function(t){this.y=t-this._h/2}}}),t("GameObject",null,{initialize:function(t,e,n){this._hitbox=new Hitbox(t,e,1,1),"string"==typeof n&&(n=r.movement(n)),i(n,Movement,"movement"),this._movement=n.bind(this)},update:function(){this._movement.update(),this._movement.apply(),this._checkDispose()},_checkDispose:function(){this.hitbox.x.between(0,h.width-1)&&this.hitbox.y.between(0,h.height-1)||this.dispose()},dispose:function(){r.remove(this)}},{hitbox:{get:function(){return this._hitbox},set:function(t){i(t,Hitbox,"value"),this._hitbox=t}},color:{get:function(){return this instanceof Player?r.currentStage.playerColor:this instanceof Enemy?r.currentStage.enemyColor:this instanceof Projectile&&this._shooter instanceof Player?r.currentStage.playerProjectileColor:this instanceof Projectile&&this._shooter instanceof Enemy?r.currentStage.enemyProjectileColor:void 0}},movement:{get:function(){return this._movement},set:function(t){i(t,Movement,"value"),this._movement=t.bind(this)}}}),t("Velocity",null,{initialize:function(t,i){e(t,"number","module"),e(i,"number","module"),this._x=t*Math.cos(i),this._y=t*Math.sin(i)},apply:function(t){i(t,GameObject,"object"),t.hitbox.x+=this._x,t.hitbox.y+=this._y}},{x:{get:function(){return this._x},set:function(t){e(t,"number","value"),this._x=t}},y:{get:function(){return this._y},set:function(t){e(t,"number","value"),this._y=t}},module:{get:function(){return this._x/Math.cos(this.angle)},set:function(t){e(t,"number","value"),this.initialize(t,this.angle)}},angle:{get:function(){return Math.atan2(this._y,this._x)||0},set:function(t){e(t,"number","value"),this.initialize(this.module,t)}}}),t("Bindable",null,{initialize:function(){throw new Error("`Bindable' é uma classe abstrata")},_initialize:function(){this._object=null},bind:function(t){var e=this.clone();return e._object=t,e}}),t("Movement","Bindable",{initialize:function(t){this.__super__._initialize.call(this),t&&(i(t,Array),this._velocities=t),this._onUpdateSrc=null,this._onUpdate=null},update:function(){if(!this._object)throw new Error("Não é possível atualizar o movimento antes de ligá-lo a um objeto");this._onUpdate&&this._onUpdate()},bind:function(t){var e=this.__super__.bind.call(this,t);return this._onUpdateSrc&&(e.onUpdate=this._onUpdateSrc),e},apply:function(){for(var t=0;t<this._velocities.length;t++)this._velocities[t].apply(this._object)}},{onUpdate:{get:function(){return this._onUpdate},set:function(t){e(t,"function","value"),this._onUpdateSrc=t,this._onUpdate=t.bind(this)}}}),t("Projectile","GameObject",{initialize:function(t,e,n,o){i(o,GameObject,"shooter"),this._shooter=o,this.__super__.initialize.call(this,t,e,n),this._hitbox.width=this._hitbox.height=4},update:function(){this.__super__.update.call(this),r.forEachObject(function(t){this._shooter instanceof Enemy?t instanceof Player&&this._hitbox.collidesWith(t.hitbox)&&(setTimeout(r.restart.bind(r),20),this.dispose()):t instanceof Enemy&&this._hitbox.collidesWith(t.hitbox)&&(t.applyDamage(),this.dispose())}.bind(this))}},{shooter:{get:function(){return this._shooter}}}),t("Enemy","GameObject",{initialize:function(t,n,o,s,h){this.__super__.initialize.call(this,t,n,o),this._hitbox.width=this._hitbox.height=10,e(s,"number","health"),e(h,"string","actions"),h=r.actionPattern(h),i(h,GameActions,"actions"),this._health=s,this._actions=h.bind(this),this._actions.on("initialize")()},applyDamage:function(){this._health--,this._checkDeath()},_checkDeath:function(){this._health<=0&&this._actions.on("death")()},update:function(){this.__super__.update.call(this),this._actions.on("update")()}},{health:{get:function(){return this._health}}}),t("GameActions","Bindable",{initialize:function(t){this.__super__._initialize.call(this),e(t,"object","events"),this._events=t},bind:function(t){var e=this.__super__.bind.call(this,t);for(var i in e._events)e._events[i]=e._events[i].bind(t);return e},on:function(t){return this._events[t]}}),t("Player","GameObject",{initialize:function(t,e){this.__super__.initialize.call(this,t,e,"player"),this._fireTimer=0,this._hitbox.width=this._hitbox.height=8},update:function(){this.__super__.update.call(this),this._hitbox.left<0&&(this._hitbox.left=0),this._hitbox.right>h.width&&(this._hitbox.right=h.width),this._hitbox.top<0&&(this._hitbox.top=0),this._hitbox.bottom>h.height&&(this._hitbox.bottom=h.height),s.actionPressed()?(this._fireTimer%=6,0==this._fireTimer++&&r.createProjectile(this.hitbox.x,this.hitbox.y,"straightUp",this)):this._fireTimer>0&&(this._fireTimer=0)},_checkDispose:function(){}}),r.createMovement("static",[]),r.createMovement("straightUp",[new Velocity(8,-Math.PI/2)]),r.createMovement("straightLeft",[new Velocity(4,Math.PI)]),r.createMovement("straightRight",[new Velocity(4,0)]),r.createMovement("rightLeft",[new Velocity(4,0)],function(){this._timer||(this._timer=0),this._timer++,this._timer%=90,0==this._timer&&(this._velocities[0].angle+=Math.PI)}),r.createMovement("leftRight",[new Velocity(4,Math.PI)],function(){this._timer||(this._timer=0),this._timer++,this._timer%=90,0==this._timer&&(this._velocities[0].angle+=Math.PI)}),r.createMovement("circleRight",[new Velocity(4,0)],function(){this._velocities[0].angle+=.1}),r.createMovement("circleLeft",[new Velocity(4,-Math.PI)],function(){this._velocities[0].angle-=.1}),r.createMovement("circleUp",[new Velocity(4,0),new Velocity(4,-Math.PI/2)],function(){this._velocities[0].angle+=.1}),r.createMovement("circleDown",[new Velocity(4,Math.PI),new Velocity(4,Math.PI/2)],function(){this._velocities[0].angle-=.1}),r.createMovement("player",[new Velocity(0,0)],function(){this._velocities[0].module=s.shiftPressed()?2:4;var t=0;switch(s.dir8()){case 1:t=3*Math.PI/4;break;case 2:t=Math.PI/2;break;case 3:t=Math.PI/4;break;case 4:t=Math.PI;break;case 6:t=0;break;case 7:t=5*Math.PI/4;break;case 8:t=3*Math.PI/2;break;case 9:t=7*Math.PI/4;break;default:this._velocities[0].module=0}this._velocities[0].angle=t}),r.createActionPattern("still",{initialize:function(){},update:function(){},death:n}),r.createActionPattern("circle",{initialize:function(){this._fireTimer=0},update:function(){var t=48;if(this._fireTimer%72==0)for(var e=0;t>=e;e++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/t*e)]),this);this._fireTimer++},death:n}),r.createActionPattern("circle1",{initialize:function(){this._fireTimer=0},update:function(){var t=24;if(this._fireTimer%72==0)for(var e=0;t>=e;e++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/t*e)]),this);this._fireTimer++},death:n}),r.createActionPattern("spiral1",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*-Math.PI/240*this._fireTimer)]),this),this._fireTimer++},death:n}),r.createActionPattern("spiral2",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/240*this._fireTimer)]),this),this._fireTimer++},death:n}),r.createActionPattern("arc1",{initialize:function(){this._timer=0},update:function(){var t=10;if(this._timer++%120==0)for(var e=0;t>=e;e++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1.5-e/t/2,Math.PI/4+Math.PI/4/t*e)]),this);if(this._timer%150==0)for(var e=0;t>=e;e++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1.5-e/t/2,Math.PI/4+Math.PI/4/t*e)]),this)},death:n}),r.createActionPattern("arc2",{initialize:function(){this._timer=0},update:function(){var t=10;if(this._timer++%120==0)for(var e=0;t>=e;e++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1+e/t/2,Math.PI/2+Math.PI/4/t*e)]),this);if(this._timer%150==0)for(var e=0;t>=e;e++)r.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1+e/t/2,Math.PI/2+Math.PI/4/t*e)]),this)},death:n}),r.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,initialize:function(){r.createEnemies([h.width/3,32,"rightLeft",10,"circle"],[2*h.width/3,32,"leftRight",10,"circle"],[h.width/2,96,"static",40,"spiral1"])},terminate:function(){}}),r.createStage({backgroundColor:16777215,playerColor:43775,enemyColor:0,playerProjectileColor:65280,enemyProjectileColor:16711680,initialize:function(){r.createEnemies([h.width/6,32,"static",20,"spiral1"],[5*h.width/6,32,"static",20,"spiral2"]),this._i1=setInterval(function(){r.createEnemy(h.width-1,48,"straightLeft",1,"circle")},3e3),this._i2=setInterval(function(){r.createEnemy(1,48,"straightRight",1,"circle")},6e3)},terminate:function(){clearInterval(this._i1),clearInterval(this._i2)}}),r.createStage({backgroundColor:1638550,playerColor:16777215,enemyColor:16711935,playerProjectileColor:65535,enemyProjectileColor:11993343,initialize:function(){r.createEnemies([h.width/3,96,"circleRight",5,"still"],[2*h.width/3,96,"circleLeft",5,"still"]),this._i1=setInterval(function(){r.createEnemies([100,h.height-128,"circleUp",1,"circle1"],[h.width-100,128,"circleDown",1,"circle1"])},3e3)},terminate:function(){clearInterval(this._i1)}}),h.initialize(),a.initialize(),r.start(),a.initialize(),o()}();