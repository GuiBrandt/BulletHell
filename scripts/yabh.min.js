//=============================================================================
// yabh.src.js
//
// Código completo do jogo todo encapsulado numa função e compactado. Agora tá
// perfeito pra usar.
//=============================================================================
"use strict";!function(){function t(t,e,i,n){if(!t||"string"!=typeof t)throw new Error("Nome inválido para a classe");if(!i||"object"!=typeof i)throw new Error("Protótipo inválido para a classe");if(window[t]=function(){this.initialize.apply(this,arguments)},e){if("string"!=typeof e)throw new Error("Tipo inválido para `super'");if("function"!=typeof window[e])throw new Error("`"+e+"' não é uma classe");window[t].prototype=Object.create(window[e].prototype),window[t].prototype.__super__=window[e].prototype,window[t].prototype.constructor=window[t];for(var o in i)window[t].prototype[o]=i[o]}else window[t].prototype=i;if(n){if("object"!=typeof n)throw new Error("Propriedades inválidas");Object.defineProperties(window[t].prototype,n)}}function e(t,e,i){if(typeof t!=e)throw new Error("Tipo inválido para `"+i+"'")}function i(t,e,i){if("object"!=typeof t||!(t instanceof e))throw new Error("Tipo inválido para `"+i+"'")}function n(){this.dispose();for(var t=0;54>=t;t++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(4,2*Math.PI/54*t)]),this);a.playSe("audio/enemyDeath.m4a",.2,.5)}function o(){s.update(),r.update(),requestAnimationFrame(o)}Number.prototype.between=function(t,i){e(t,"number","a"),e(i,"number","b");var n=t>i?t:i,o=i>t?t:i;return this>=o&&n>=this},Object.prototype.clone=function(){var t=Object.create(this);if(this instanceof Array)for(var e=0;e<this.length;e++)this[e]&&"object"==typeof this[e]?t[e]=this[e].clone():t[e]=this[e];else for(var i in this)this.hasOwnProperty(i)&&(this[i]&&"object"==typeof this[i]?t[i]=this[i].clone():t[i]=this[i]);return t},Array.prototype.contains=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return!0;return!1},Array.prototype.remove=function(t){this.splice(this.indexOf(t),1)};var h={_codes:{shift:16,space:32,left:37,up:38,right:39,down:40,z:90},_keysDown:[],reset:function(){this._keysDown=[]},dir8:function(){var t=this._keysDown.contains(this._codes.left),e=this._keysDown.contains(this._codes.up),i=this._keysDown.contains(this._codes.right),n=this._keysDown.contains(this._codes.down);return t?n?1:e?7:4:i?n?3:e?9:6:e?8:n?2:0},shiftPressed:function(){return this._keysDown.contains(this._codes.shift)},actionPressed:function(){return this._keysDown.contains(this._codes.z)||this._keysDown.contains(this._codes.space)}};document.addEventListener("keydown",function(t){h._keysDown.contains(t.keyCode)||h._keysDown.push(t.keyCode)}),document.addEventListener("keyup",function(t){h._keysDown.remove(t.keyCode)}),window.addEventListener("blur",function(){h._keysDown=[]});var s={_player:null,_objects:[],_stages:[],_movements:{},_actionPatterns:{},_stageID:0,_pause:!1,start:function(){this.createPlayer(),this.setupStage()},update:function(){for(var t=0,e=!1;t<this._objects.length&&!e;)e=this._objects[t++]instanceof Enemy;return e||(this.currentStage.terminate(),this.nextStage(),this.setupStage()),h._keysDown.contains(17)?this.restart():(h._keysDown.contains(27)?this._pause=!0:h.actionPressed()&&(this._pause=!1),void(this._pause||this.forEachObject(function(t){t.update()})))},restart:function(){this.currentStage.terminate(),this.clear(),this.start()},clear:function(){this.forEachObject(function(t){t.dispose()}),this._objects=[]},setupStage:function(){this.currentStage?(r.backgroundColor=this.currentStage.backgroundColor,a.playBgm.apply(a,this.currentStage.bgm),this.currentStage.initialize()):this.nextStage()},nextStage:function(){this._stageID++,this._checkFinished()},_checkFinished:function(){this._stageID>=this._stages.length&&(this._stageID=0,this.restart())},createPlayer:function(){return this._player=new Player(r.width/2,r.height-32),this.add(this._player),this._player},createMovement:function(t,n,o){return e(t,"string","name"),i(n,Array,"velocities"),this._movements[t]||(this._movements[t]=new Movement(n),o&&(this._movements[t].onUpdate=o)),this._movements[t]},createActionPattern:function(t,i){return e(t,"string","name"),this._actionPatterns[t]=new GameActions(i),this._actionPatterns[t]},createStage:function(t){e(t,"object","obj"),this._stages.push(t)},createEnemy:function(t,e,i,n,o){var h=new Enemy(t,e,i,n,o);return this.add(h),h},createEnemies:function(){for(var t=[],e=0;e<arguments.length;e++)i(arguments[e],Array,"arguments["+e+"]"),t.push(this.createEnemy.apply(this,arguments[e]));return t},createProjectile:function(t,e,i,n){var o=new Projectile(t,e,i,n);return this.add(o),n instanceof Player&&a.playSe("audio/playerShot.m4a",.1,2),o},movement:function(t){return e(t,"string","name"),this._movements[t]},actionPattern:function(t){return e(t,"string","name"),this._actionPatterns[t]},add:function(t){i(t,GameObject,"obj"),this._objects.push(t)},remove:function(t){i(t,GameObject,"obj"),this._objects.remove(t)},forEachObject:function(t){for(var e=0;e<this._objects.length;e++)t.call(null,this._objects[e])}};Object.defineProperties(s,{currentStage:{get:function(){return this._stages[this._stageID]}},player:{get:function(){return this._player}}});var r={initialize:function(){this._canvas=document.createElement("canvas"),this.width=640,this.height=480,this._canvas.id="GameCanvas",this._context=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)},update:function(){this._context.clearRect(0,0,this.width,this.height),s.forEachObject(function(t){var e=t.color.toString(16),i="#"+"000000".substring(0,6-e.length)+e;i!=this._context.fillStyle&&(this._context.fillStyle=i),this._context.fillRect(t.hitbox.left,t.hitbox.top,t.hitbox.width,t.hitbox.height)}.bind(this))}};Object.defineProperties(r,{width:{get:function(){return this._canvas.width},set:function(t){e(t,"number","value"),this._canvas.width=t}},height:{get:function(){return this._canvas.height},set:function(t){e(t,"number","value"),this._canvas.height=t}},backgroundColor:{get:function(){return this._canvas.style.backgroundColor},set:function(t){e(t,"number","value");var i=t.toString(16);this._canvas.style.backgroundColor="#"+"000000".substring(0,6-i.length)+i}}});var a={initialize:function(){this._bgm=new Audio,this._mute=!1,this._currentBgm=""},playBgm:function(t,i,n){this._mute||(e(t,"string","filename"),i&&(e(i,"number","volume"),this._bgm.volume=i),n&&(e(n,"number","pitch"),this._bgm.playbackRate=n),this._currentBgm!=t&&(this._bgm.pause(),this._currentBgm=t,this._bgm.src=t,this._bgm.addEventListener("canplay",function(){this._bgm.play(),this._bgm.addEventListener("ended",function(){this._bgm.play()}.bind(this))}.bind(this))))},stopBgm:function(){this._bgm.pause()},playSe:function(t,i,n){if(!this._mute){e(t,"string","filename");var o=new Audio(t);return i&&(e(i,"number","volume"),o.volume=i),n&&(e(n,"number","pitch"),o.playbackRate=n),o.play(),o}}};t("Hitbox",null,{initialize:function(t,i,n,o){if(e(t,"number","x"),e(t,"number","y"),e(t,"number","w"),e(t,"number","h"),0>=n)throw new Error("A largura da hitbox deve ser maior que zero");if(0>=o)throw new Error("A altura da hitbox deve ser maior que zero");this._x=t,this._y=i,this._w=n,this._h=o},collidesWith:function(t){i(t,Hitbox,"other");var e=0;return this.right.between(t.left,t.right)?e++:this.left.between(t.left,t.right)&&e++,this.bottom.between(t.top,t.bottom)?e++:this.top.between(t.top,t.bottom)&&e++,e>1}},{x:{get:function(){return this._x},set:function(t){e(t,"number","value"),this._x=t}},y:{get:function(){return this._y},set:function(t){e(t,"number","value"),this._y=t}},width:{get:function(){return this._w},set:function(t){if(e(t,"number","value"),0>t)throw new Error("A largura deve ser maior que zero");this._w=t,this.x=this._x}},height:{get:function(){return this._h},set:function(t){if(e(t,"number","value"),0>t)throw new Error("A altura deve ser maior que zero");this._h=t,this.y=this._y}},left:{get:function(){return this._x-this._w/2},set:function(t){this.x=t+this._w/2}},right:{get:function(){return this._x+this._w/2},set:function(t){this.x=t-this._w/2}},top:{get:function(){return this._y-this._h/2},set:function(t){this.y=t+this._h/2}},bottom:{get:function(){return this._y+this._h/2},set:function(t){this.y=t-this._h/2}}}),t("GameObject",null,{initialize:function(t,e,n){this._hitbox=new Hitbox(t,e,1,1),"string"==typeof n&&(n=s.movement(n)),i(n,Movement,"movement"),this._movement=n.bind(this),this._color=null},update:function(){this._movement.update(),this._movement.apply(),this._checkDispose()},_checkDispose:function(){this.hitbox.x.between(0,r.width-1)&&this.hitbox.y.between(0,r.height-1)||this.dispose()},dispose:function(){s.remove(this)}},{hitbox:{get:function(){return this._hitbox},set:function(t){i(t,Hitbox,"value"),this._hitbox=t}},color:{get:function(){return this._color?this._color:this instanceof Player?s.currentStage.playerColor:this instanceof Enemy?s.currentStage.enemyColor:this instanceof Projectile&&this._shooter instanceof Player?s.currentStage.playerProjectileColor:this instanceof Projectile&&this._shooter instanceof Enemy?s.currentStage.enemyProjectileColor:void 0},set:function(t){e(t,"number","value"),this._color=t}},movement:{get:function(){return this._movement},set:function(t){i(t,Movement,"value"),this._movement=t.bind(this)}}}),t("Velocity",null,{initialize:function(t,i){e(t,"number","module"),e(i,"number","module"),this._x=t*Math.cos(i),this._y=t*Math.sin(i)},apply:function(t){i(t,GameObject,"object"),t.hitbox.x+=this._x,t.hitbox.y+=this._y}},{x:{get:function(){return this._x},set:function(t){e(t,"number","value"),this._x=t}},y:{get:function(){return this._y},set:function(t){e(t,"number","value"),this._y=t}},module:{get:function(){return this._x/Math.cos(this.angle)},set:function(t){e(t,"number","value"),this.initialize(t,this.angle)}},angle:{get:function(){return Math.atan2(this._y,this._x)||0},set:function(t){e(t,"number","value"),this.initialize(this.module,t)}}}),t("Bindable",null,{initialize:function(){throw new Error("`Bindable' é uma classe abstrata")},_initialize:function(){this._object=null},bind:function(t){var e=this.clone();return e._object=t,e}}),t("Movement","Bindable",{initialize:function(t){this.__super__._initialize.call(this),t&&(i(t,Array),this._velocities=t),this._onUpdateSrc=null,this._onUpdate=null},update:function(){if(!this._object)throw new Error("Não é possível atualizar o movimento antes de ligá-lo a um objeto");this._onUpdate&&this._onUpdate()},bind:function(t){var e=this.__super__.bind.call(this,t);return this._onUpdateSrc&&(e.onUpdate=this._onUpdateSrc),e},apply:function(){for(var t=0;t<this._velocities.length;t++)this._velocities[t].apply(this._object)}},{onUpdate:{get:function(){return this._onUpdate},set:function(t){e(t,"function","value"),this._onUpdateSrc=t,this._onUpdate=t.bind(this)}}}),t("Projectile","GameObject",{initialize:function(t,e,n,o){i(o,GameObject,"shooter"),this._shooter=o,this.__super__.initialize.call(this,t,e,n),this._hitbox.width=this._hitbox.height=5},update:function(){this.__super__.update.call(this),s.forEachObject(function(t){this._shooter instanceof Enemy?t instanceof Player&&this._hitbox.collidesWith(t.hitbox)&&(setTimeout(s.restart.bind(s),20),this.dispose()):t instanceof Enemy&&this._hitbox.collidesWith(t.hitbox)&&(t.applyDamage(),this.dispose())}.bind(this))}},{shooter:{get:function(){return this._shooter}}}),t("Enemy","GameObject",{initialize:function(t,n,o,h,r){this.__super__.initialize.call(this,t,n,o),this._hitbox.width=this._hitbox.height=10,e(h,"number","health"),e(r,"string","actions"),r=s.actionPattern(r),i(r,GameActions,"actions"),this._maxHealth=h,this._health=h,this._actions=r.bind(this),this._actions.on("initialize")()},applyDamage:function(){this._health--,this._checkDeath()},_checkDeath:function(){this._health<=0&&this._actions.on("death")()},update:function(){this.__super__.update.call(this),this._actions.on("update")()}},{health:{get:function(){return this._health}},maxHealth:{get:function(){return this._maxHealth}}}),t("GameActions","Bindable",{initialize:function(t){this.__super__._initialize.call(this),e(t,"object","events"),this._events=t},bind:function(t){var e=this.__super__.bind.call(this,t);for(var i in e._events)e._events[i]=e._events[i].bind(t);return e},on:function(t){return this._events[t]}}),t("Player","GameObject",{initialize:function(t,e){this.__super__.initialize.call(this,t,e,"player"),this._fireTimer=0,this._hitbox.width=this._hitbox.height=8},update:function(){this.__super__.update.call(this),this._hitbox.left<0&&(this._hitbox.left=0),this._hitbox.right>r.width&&(this._hitbox.right=r.width),this._hitbox.top<0&&(this._hitbox.top=0),this._hitbox.bottom>r.height&&(this._hitbox.bottom=r.height),h.actionPressed()?(this._fireTimer%=6,0==this._fireTimer++&&s.createProjectile(this.hitbox.x,this.hitbox.y,"straightUp",this)):this._fireTimer>0&&(this._fireTimer=0)},_checkDispose:function(){}}),s.createMovement("static",[]),s.createMovement("straightUp",[new Velocity(8,-Math.PI/2)]),s.createMovement("straightLeft",[new Velocity(4,Math.PI)]),s.createMovement("straightRight",[new Velocity(4,0)]),s.createMovement("rightLeft",[new Velocity(4,0)],function(){this._timer||(this._timer=0),this._timer++,this._timer%=90,0==this._timer&&(this._velocities[0].angle+=Math.PI)}),s.createMovement("leftRight",[new Velocity(4,Math.PI)],function(){this._timer||(this._timer=0),this._timer++,this._timer%=90,0==this._timer&&(this._velocities[0].angle+=Math.PI)}),s.createMovement("circleRight",[new Velocity(4,0)],function(){this._velocities[0].angle+=.1}),s.createMovement("circleLeft",[new Velocity(4,-Math.PI)],function(){this._velocities[0].angle-=.1}),s.createMovement("circleUp",[new Velocity(4,0),new Velocity(4,-Math.PI/2)],function(){this._velocities[0].angle+=.1}),s.createMovement("circleDown",[new Velocity(4,Math.PI),new Velocity(4,Math.PI/2)],function(){this._velocities[0].angle-=.1}),s.createMovement("chasePlayer",[new Velocity(4,0)],function(){var t=this._object.hitbox.y-s.player.hitbox.y,e=this._object.hitbox.x-s.player.hitbox.x,i=Math.atan2(t,e);this._velocities[0].angle=i+Math.PI}),s.createMovement("targetPlayer",[new Velocity(4,0)],function(){if(!this._targetingPlayer){this._targetingPlayer=!0;var t=this._object.hitbox.y-s.player.hitbox.y,e=this._object.hitbox.x-s.player.hitbox.x,i=Math.atan2(t,e);this._velocities[0].angle=i+Math.PI}}),s.createMovement("player",[new Velocity(0,0)],function(){this._velocities[0].module=h.shiftPressed()?2:4;var t=0;switch(h.dir8()){case 1:t=3*Math.PI/4;break;case 2:t=Math.PI/2;break;case 3:t=Math.PI/4;break;case 4:t=Math.PI;break;case 6:t=0;break;case 7:t=5*Math.PI/4;break;case 8:t=3*Math.PI/2;break;case 9:t=7*Math.PI/4;break;default:this._velocities[0].module=0}this._velocities[0].angle=t}),s.createActionPattern("still",{initialize:function(){},update:function(){},death:n}),s.createActionPattern("targetPlayer",{initialize:function(){this._timer=0,this._timeouts=[]},update:function(){if(this._timer++,this._timer%60==0&&this._hitbox.y+64<s.player.hitbox.y)for(var t=0;1>t;t++)this._timeouts.push(setTimeout(function(){s.createProjectile(this._hitbox.x,this._hitbox.y,"targetPlayer",this)}.bind(this),200*t+1))},death:function(){for(var t=0;t<this._timeouts.length;t++)clearTimeout(this._timeouts[t])}}),s.createActionPattern("circle",{initialize:function(){this._fireTimer=0},update:function(){var t=48;if(this._fireTimer%72==0){for(var e=0;t>=e;e++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/t*e)]),this);a.playSe("audio/enemyShot01.m4a",.05,.5)}this._fireTimer++},death:n}),s.createActionPattern("circle1",{initialize:function(){this._fireTimer=0},update:function(){var t=24;if(this._fireTimer%72==0){for(var e=0;t>=e;e++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/t*e)]),this);a.playSe("audio/enemyShot01.m4a",.05,.5)}this._fireTimer++},death:n}),s.createActionPattern("spiral1",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*-Math.PI/240*this._fireTimer)]),this),this._fireTimer++},death:n}),s.createActionPattern("spiral2",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/240*this._fireTimer)]),this),this._fireTimer++},death:n}),s.createActionPattern("arc1",{initialize:function(){this._timer=0},update:function(){var t=10;if(this._timer++%120==0)for(var e=0;t>=e;e++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1.5-e/t/2,Math.PI/4+Math.PI/4/t*e)]),this);if(this._timer%150==0)for(var e=0;t>=e;e++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1.5-e/t/2,Math.PI/4+Math.PI/4/t*e)]),this)},death:n}),s.createActionPattern("arc2",{initialize:function(){this._timer=0},update:function(){var t=10;if(this._timer++%120==0)for(var e=0;t>=e;e++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1+e/t/2,Math.PI/2+Math.PI/4/t*e)]),this);if(this._timer%150==0)for(var e=0;t>=e;e++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(1+e/t/2,Math.PI/2+Math.PI/4/t*e)]),this)},death:n}),s.createActionPattern("boss1",{initialize:function(){this._fireTimer=0,this._deathCount=0,this._positioned=!0},update:function(){var t=this._maxHealth-this._health,e=t/this._maxHealth;if(this._positioned)switch(this._deathCount){case 2:if(this._fireTimer%Math.floor(10-3*e)==0)for(var i=0;2>i;i++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*-Math.PI/240*this._fireTimer-i*Math.PI/16)]),this),s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,Math.PI/2-2*Math.PI/240*this._fireTimer-i*Math.PI/16)]),this),s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,Math.PI-2*Math.PI/240*this._fireTimer-i*Math.PI/16)]),this),s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,3*Math.PI/2-2*Math.PI/240*this._fireTimer-i*Math.PI/16)]),this);case 1:case 0:if(this._fireTimer%Math.floor(10-3*e)==0)for(var i=0;2>i;i++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,2*Math.PI/240*this._fireTimer+i*Math.PI/16)]),this),s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,Math.PI/2+2*Math.PI/240*this._fireTimer+i*Math.PI/16)]),this),s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,Math.PI+2*Math.PI/240*this._fireTimer+i*Math.PI/16)]),this),s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,3*Math.PI/2+2*Math.PI/240*this._fireTimer+i*Math.PI/16)]),this);break;case 3:for(var i=0;2>i;i++)s.createProjectile(this._hitbox.x,this._hitbox.y,new Movement([new Velocity(2,Math.random()*Math.PI*2)]),this)}var n=255,o=255&Math.floor(255-255*e);this._color=(n<<16)+(o<<8)+o,this._fireTimer++},death:function(){this._deathCount++,1==this._deathCount?(this._positioned=!1,this.movement=new Movement([new Velocity(4,0)]),this._onPosInterval=setInterval(function(){this.hitbox.x>=2*r.width/3&&(this.movement=s.movement("static"),clearInterval(this._onPosInterval),this._positioned=!0)}.bind(this),10)):2==this._deathCount?(this.movement=new Movement([new Velocity(.3,Math.PI)]),this.movement.onUpdate=function(){0==this._velocities[0].angle&&this._object.hitbox.x>=2*r.width/3?this._velocities[0].angle=Math.PI:this._velocities[0].angle==Math.PI&&this._object.hitbox.x<=r.width/3&&(this._velocities[0].angle=0)}):3==this._deathCount&&(this.movement=s.movement("circleRight")),4==this._deathCount?this.dispose():this._health=this._maxHealth}}),s.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,bgm:["audio/badapple.mp3"],initialize:function(){var t=s.createEnemy(r.width/2,128,"static",40,"circle1");this._i1=setInterval(function(){if(!(t.health<=0)){s.createEnemy(Math.random()*r.width,0,new Movement([new Velocity(3,Math.random()*Math.PI/4+Math.PI/4)]),1,"targetPlayer")}},1e3)},terminate:function(){clearInterval(this._i1)}}),s.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,bgm:["audio/badapple.mp3"],initialize:function(){s.createEnemies([r.width/6,32,"static",15,"arc1"],[5*r.width/6,32,"static",15,"arc2"]),this._i1=setInterval(function(){s.createEnemy(r.width-1,64*Math.random()+32,"straightLeft",1,"spiral2")},3e3),this._i2=setInterval(function(){s.createEnemy(1,64*Math.random()+32,"straightRight",1,"spiral2")},6e3)},terminate:function(){clearInterval(this._i1),clearInterval(this._i2)}}),s.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,bgm:["audio/megalovania.mp3"],initialize:function(){var t=s.createEnemy(r.width/3,96,"static",60,"boss1");t.hitbox.width=t.hitbox.height=16,t.color=16777215},terminate:function(){}}),r.initialize(),a.initialize(),s.start(),o()}();