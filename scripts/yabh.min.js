//=============================================================================
// yabh.src.js
//
// Código completo do jogo todo encapsulado numa função e compactado. Agora tá
// perfeito pra usar.
//=============================================================================
"use strict";!function(){function t(t,i,n){if(!i||"object"!=typeof i)throw new Error("Protótipo inválido para a classe");var o=function(){this.initialize.apply(this,arguments)};if(t){e(t,"function","_super"),o.prototype=Object.create(t.prototype),o.prototype.__super__=t.prototype,o.prototype.constructor=o;for(var r in i)o.prototype[r]=i[r]}else o.prototype=i;if(n){if("object"!=typeof n)throw new Error("Propriedades inválidas");Object.defineProperties(o.prototype,n)}return o}function e(t,e,i){if(typeof t!=e)throw new Error("Tipo inválido para `"+i+"'")}function i(t,e,i){if("object"!=typeof t||!(t instanceof e))throw new Error("Tipo inválido para `"+i+"'")}function n(){this.dispose();for(var t=0;54>=t;t++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(4,2*Math.PI/54*t)]),this);c.playSe("audio/enemyDeath.m4a",.2,.5)}function o(){u.measure(function(){u.needsSkip()||(w?(a.fullClear(),w=!1):a.clear()),h.update(),u.needsSkip()?(u.skipped(),w=!0):a.render()}),requestAnimationFrame(o)}Number.prototype.between=function(t,i){e(t,"number","a"),e(i,"number","b");var n=t>i?t:i,o=i>t?t:i;return this>=o&&n>=this},Object.prototype.clone=function(){var t=Object.create(this);if(this instanceof Array)for(var e=0;e<this.length;e++)this[e]&&"object"==typeof this[e]?t[e]=this[e].clone():t[e]=this[e];else for(var i in this)this.hasOwnProperty(i)&&(this[i]&&"object"==typeof this[i]?t[i]=this[i].clone():t[i]=this[i]);return t},Array.prototype.contains=function(t){for(var e=0;e<this.length;e++)if(this[e]==t)return!0;return!1},Array.prototype.remove=function(t){this.splice(this.indexOf(t),1)},window.isTouchDevice=function(){return"ontouchstart"in window};var r={_codes:{shift:16,space:32,left:37,up:38,right:39,down:40,z:90},_keysDown:[],reset:function(){this._keysDown=[]},dir8:function(){var t=this._keysDown.contains(this._codes.left),e=this._keysDown.contains(this._codes.up),i=this._keysDown.contains(this._codes.right),n=this._keysDown.contains(this._codes.down);return t?n?1:e?7:4:i?n?3:e?9:6:e?8:n?2:0},shiftPressed:function(){return this._keysDown.contains(this._codes.shift)},actionPressed:function(){return this._keysDown.contains(this._codes.z)||this._keysDown.contains(this._codes.space)||s._action}};document.addEventListener("keydown",function(t){r._keysDown.contains(t.keyCode)||r._keysDown.push(t.keyCode)}),document.addEventListener("keyup",function(t){r._keysDown.remove(t.keyCode)}),window.addEventListener("blur",function(){r._keysDown=[]});var s={_action:!1,_analogOrigin:null,_analog:null,_actionTouchId:-1,_touchId:-1,_ox:-1,_oy:-1,_x:0,_y:0,initialize:function(){function t(t){t.preventDefault(),h.pause=!1;for(var e,i,n=0;n<t.changedTouches.length;n++)e=t.changedTouches[n].pageX,i=t.changedTouches[n].pageY,document.elementFromPoint(e,i)!=this._actionButton?this._touchId=t.changedTouches[n].identifier:(this._action=!0,this._actionTouchId=t.changedTouches[n].identifier,e=i=null);if(null!=e&&null!=i){this._analogOrigin=this._analogOrigin||document.createElement("div");var o=this._analogOrigin.style;o.backgroundColor="rgba(200, 200, 200, 0.5)";var r="7em";o.height=o.width=r,o.borderRadius=r,o.position="fixed",o.left=e+"px",o.top=i+"px",o.zIndex=20,o.transform="translateX(-50%) translateY(-50%)",this._analog=this._analog||document.createElement("div"),o=this._analog.style,o.backgroundColor="rgba(255, 255, 255, 0.5)";var r="6.5em";o.height=o.width=r,o.borderRadius=r,o.position="fixed",o.left=e+"px",o.top=i+"px",o.zIndex=20,o.transform="translateX(-50%) translateY(-50%)",this._ox=e,this._oy=i,this._x=e,this._y=i,document.body.appendChild(this._analogOrigin),document.body.appendChild(this._analog)}}function e(t){t.preventDefault();for(var e=-1,i=-1,n=0;n<t.changedTouches.length;n++)this._touchId==t.changedTouches[n].identifier&&(e=t.changedTouches[n].pageX,i=t.changedTouches[n].pageY);0>e||0>i||!this._analog||(this._x=e,this._y=i,this._analog.style.left=e+"px",this._analog.style.top=i+"px")}function i(t){t.preventDefault();for(var e=0;e<t.changedTouches.length;e++){var i=t.changedTouches[e].identifier;i==this._actionTouchId?(this._action=!1,this._actionTouchId=-1):i==this._touchId&&(document.body.removeChild(this._analogOrigin),document.body.removeChild(this._analog),this._ox=-1,this._oy=-1)}}this._actionButton=document.createElement("div");var n=this._actionButton.style;n.backgroundColor="rgba(255, 255, 255, 0.5)";var o="6em";n.height=n.width=o,n.borderRadius=o,n.position="fixed",n.right="3em",n.bottom="3em",n.zIndex=20,document.body.appendChild(this._actionButton),window.addEventListener("touchstart",t.bind(this)),window.addEventListener("touchmove",e.bind(this)),window.addEventListener("touchend",i.bind(this))},getAngle:function(){if(this._ox<0||this._oy<0)return 0;var t=this._x-this._ox,e=this._y-this._oy;return Math.atan2(e,t)},getModule:function(t){if(this._ox<0||this._oy<0)return 0;this._x-this._ox,this._y-this._oy;return t}},h={_player:null,_objects:[],_newObjects:[],_stages:[],_movements:{},_actionPatterns:{},_stageID:0,_pause:!1,_stop:!1,_showText:!0,start:function(){this._clock=0,this.createPlayer(),this.setupStage()},update:function(){if(!this._stop){this._updating=!0;var t=!1;if(!this._pause)for(var e=0;e<this._objects.length;e++)t||(t=this._objects[e]instanceof v,t=t||this._objects[e]instanceof p&&this._objects[e].shooter instanceof v),this._objects[e]&&this._objects[e].update();this._pause||t||(this.currentStage.terminate(),this.nextStage(),this.setupStage()),this._clock++;for(var e=0;e<this._newObjects.length;e++)this.__add(this._newObjects[e]);for(this._newObjects=[];this._objects.contains(null);)this._objects.remove(null);return this._updating=!1,r._keysDown.contains(17)&&!this._pause?this.restart():void(r._keysDown.contains(27)||r._keysDown.contains(226)?this._pause=!0:r.actionPressed()&&(this._pause=!1))}},restart:function(){this.currentStage.terminate(),this._stop=!1,this.clear(),this.start()},clear:function(){this.forEachObject(function(t){t.dispose()}),this._player&&this._player.dispose(),this._player=null,a.fullClear(),this._objects=[],this._newObjects=[]},setupStage:function(){this.currentStage?(a.backgroundColor=this.currentStage.backgroundColor,c.playBgm.apply(c,this.currentStage.bgm),this.currentStage.initialize(!this._showText),this._showText=!1):this.nextStage()},nextStage:function(){this._stageID++,this._showText=!0,this._checkFinished()},_checkFinished:function(){this._stageID>=this._stages.length&&(console.log("Você zerou o jogo!"),this._stageID=0)},createPlayer:function(){return this._player=new y(a.width/2,a.height-32),this.add(this._player),this._player},createMovement:function(t,n,o){return e(t,"string","name"),i(n,Array,"velocities"),this._movements[t]||(this._movements[t]=new g(n),o&&(this._movements[t].onUpdate=o)),this._movements[t]},createLinearMovement:function(t,n){return e(t,"string","name"),i(n,Array,"velocities"),this._movements[t]||(this._movements[t]=new b(n)),i(this._movements[t],b,"Game.movement('"+t+"')"),this._movements[t]},createActionPattern:function(t,i){return e(t,"string","name"),this._actionPatterns[t]=new x(i),this._actionPatterns[t]},createStage:function(t){e(t,"object","obj"),this._stages.push(t)},createEnemy:function(t,e,i,n,o){var r=new v(t,e,i,n,o);return this.add(r),r},createEnemies:function(){for(var t=[],e=0;e<arguments.length;e++)i(arguments[e],Array,"arguments["+e+"]"),t.push(this.createEnemy.apply(this,arguments[e]));return t},createProjectile:function(t,e,i,n){var o=new p(t,e,i,n);return this.add(o),n instanceof y&&c.playSe("audio/playerShot.m4a",.1,2),o},movement:function(t){return e(t,"string","name"),this._movements[t]},actionPattern:function(t){return e(t,"string","name"),this._actionPatterns[t]},add:function(t){return this._pause?!1:void(this._updating?(i(t,f,"obj"),this._newObjects.push(t)):this.__add(t))},__add:function(t){if(i(t,f,"obj"),!this._objects.contains(t)){for(var e=0,n=this._objects.length-1,o=0;n>=e;){if(o=Math.floor((e+n)/2),this._objects[o]==t)return;if(null==this._objects[o]||this._objects[o].color<t.color)e=o+1;else{if(this._objects[o].color==t.color)break;this._objects[o].color>t.color&&(n=o-1)}}this._objects.splice(o,0,t)}},remove:function(t){i(t,f,"obj"),this._updating?this._objects[this._objects.indexOf(t)]=null:this._objects.remove(t)},forEachObject:function(t){for(var e=0;e<this._objects.length;e++)null!=this._objects[e]&&t.call(null,this._objects[e])}};Object.defineProperties(h,{currentStage:{get:function(){return this._stages[this._stageID]}},currentStageID:{get:function(){return this._stageID+1}},clock:{get:function(){return this._clock}},player:{get:function(){return this._player}},pause:{get:function(){return this._pause},set:function(t){e(t,"boolean","value"),this._pause=t}}}),window.addEventListener("blur",function(){h._stop||(h.pause=!0)});var a={_bufferSize:512,_backgroundColor:0,_invertColors:!1,initialize:function(t){(void 0==t||null==t)&&(t=!0),e(t,"boolean","webgl"),this._useWebGL=t,this._canvas=document.createElement("canvas"),this._canvas.id="GameCanvas",this.width=640,this.height=480,this._useWebGL?(this._initWebGL(),this._initShaders(),this._initVerticesBuffer()):this._initCanvas(),document.body.appendChild(this._canvas)},_initCanvas:function(){this._canvasContext=this._canvas.getContext("2d")},_initWebGL:function(){try{if(window.gl=this._canvas.getContext("webgl")||this._canvas.getContext("experimental-webgl"),!gl)throw new Error;gl.viewport(0,0,this._canvas.width,this._canvas.height),gl.disable(gl.DEPTH_TEST),this._glDrawMode=gl.TRIANGLES}catch(t){alert("Falha ao inicializar WebGL"),this._useWebGL=!1,this._initCanvas()}},_loadShader:function(t){var e=document.getElementById(t);if(e)return e.innerText;throw new Error("Falha ao carregar shader `"+t+"'")},_initShaders:function(){function t(t){if(gl.compileShader(t),!gl.getShaderParameter(t,gl.COMPILE_STATUS))throw new Error("Erro de compilação no shader: "+gl.getShaderInfoLog(t))}var e=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(e,this._loadShader("color-fragshader")),t(e);var i=gl.createShader(gl.VERTEX_SHADER);if(gl.shaderSource(i,this._loadShader("pixel-vxshader")),t(i),this._shaderProgram=gl.createProgram(),gl.attachShader(this._shaderProgram,i),gl.attachShader(this._shaderProgram,e),gl.linkProgram(this._shaderProgram),!gl.getProgramParameter(this._shaderProgram,gl.LINK_STATUS))throw new Error("Não foi possível inicializar os shaders");gl.useProgram(this._shaderProgram),this._vertPosAttr=gl.getAttribLocation(this._shaderProgram,"vertexPosition"),gl.enableVertexAttribArray(this._vertPosAttr);var n=gl.getUniformLocation(this._shaderProgram,"screenSize");gl.uniform2f(n,this.width,this.height),this._colorUniform=gl.getUniformLocation(this._shaderProgram,"color")},_initVerticesBuffer:function(){this._vbos=[],this._vibs=[]},_drawObjects:function(t,e){if(!this._vbos[t]){this._vbos[t]=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this._vbos[t]),gl.bufferData(gl.ARRAY_BUFFER,8*this._bufferSize*8,gl.STREAM_DRAW),gl.vertexAttribPointer(this._vertPosAttr,2,gl.FLOAT,gl.FALSE,0,0),this._vibs[t]=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._vibs[t]);for(var i=new Uint16Array(6*this._bufferSize),n=0;6*n<i.length;n+=1){var o=6*n,r=4*n;i[o]=r,i[o+1]=r+1,i[o+2]=r+3,i[o+3]=r,i[o+4]=r+2,i[o+5]=r+3}gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,i,gl.STATIC_DRAW)}this._invertColors?gl.uniform3f(this._colorUniform,1-(t>>16&255)/255,1-(t>>8&255)/255,1-(255&t)/255):gl.uniform3f(this._colorUniform,(t>>16&255)/255,(t>>8&255)/255,(255&t)/255);for(var s=new Float32Array(8*e.length),o=0;o<e.length;o++){var h=((e[o].hitbox.left<<1)-a.width)/a.width,c=-((e[o].hitbox.top<<1)-a.height)/a.height,l=((e[o].hitbox.right<<1)-a.width)/a.width,u=-((e[o].hitbox.bottom<<1)-a.height)/a.height,_=8*o;s[_]=h,s[_+1]=c,s[_+2]=l,s[_+3]=c,s[_+4]=h,s[_+5]=u,s[_+6]=l,s[_+7]=u}gl.bufferSubData(gl.ARRAY_BUFFER,0,s),gl.drawElements(this._glDrawMode,6*e.length,gl.UNSIGNED_SHORT,0)},_renderWebGL:function(){var t=-1,e=[];h.forEachObject(function(i){-1==t?t=i.color:t!=i.color&&(this._drawObjects(t,e),e=[],t=i.color),e.push(i)}.bind(this)),this._drawObjects(t,e)},fullClear:function(){this._useWebGL||this._canvasContext.clearRect(0,0,this.width,this.height)},clear:function(){this._useWebGL?gl.clear(gl.COLOR_BUFFER_BIT):h.forEachObject(function(t){this._canvasContext.clearRect(t.hitbox.left+.5|0,t.hitbox.top+.5|0,t.hitbox.width+.5|0,t.hitbox.height+.5|0)}.bind(this))},invertColors:function(){this._invertColors=!this._invertColors,this.backgroundColor=16777215-this.backgroundColor},_renderCanvas:function(){var t=-1;h.forEachObject(function(e){if(t!=e.color){var i=e.color.toString(16);this._canvasContext.fillStyle="#"+"000000".substring(0,6-i.length)+i,t=i}this._canvasContext.fillRect(e.hitbox.left+.5|0,e.hitbox.top+.5|0,e.hitbox.width+.5|0,e.hitbox.height+.5|0)}.bind(this))},render:function(){this._useWebGL?this._renderWebGL():this._renderCanvas()}};Object.defineProperties(a,{width:{get:function(){return this._canvas.width},set:function(t){e(t,"number","value"),this._canvas.width=t}},height:{get:function(){return this._canvas.height},set:function(t){e(t,"number","value"),this._canvas.height=t}},backgroundColor:{get:function(){return this._backgroundColor},set:function(t){e(t,"number","value");var i=t.toString(16);this._canvas.style.backgroundColor="#"+"000000".substring(0,6-i.length)+i,this._backgroundColor=t}}});var c={initialize:function(){this._bgm=new Audio,this._mute=!1,this._currentBgm=""},playBgm:function(t,i,n){this._mute||(e(t,"string","filename"),i&&(e(i,"number","volume"),this._bgm.volume=i),n&&(e(n,"number","pitch"),this._bgm.playbackRate=n),this._currentBgm!=t&&(this._bgm.pause(),this._currentBgm=t,this._bgm.src=t,this._bgm.addEventListener("canplay",function(){this._bgm.play(),this._bgm.addEventListener("ended",function(){this._bgm.play()}.bind(this))}.bind(this))))},stopBgm:function(){this._bgm.pause()},playSe:function(t,i,n){if(!this._mute){e(t,"string","filename");var o=new Audio(t);return i&&(e(i,"number","volume"),o.volume=i),n&&(e(n,"number","pitch"),o.playbackRate=n),o.play(),o}}},l={initialize:function(){this._elements=[]},createText:function(t,i,n,o){e(t,"string","text"),e(i,"string","x"),e(n,"string","y"),o=o||{},e(o,"object","style");var r=document.createElement("span");r.innerHTML=t,r.style.zIndex=1,r.style.position="absolute",r.style.left=i,r.style.top=n,r.style.textShadow="0px 0px 1px #000, 0px 0px 1px #000, 0px 0px 1px #000, 0px 0px 1px #000, 0px 0px 1px #000, 0px 0px 1px #000, 0px 0px 1px #000, 0px 0px 1px #000";for(var s in o)r.style[s]=o[s];return document.body.appendChild(r),this._elements.push(r),this._elements.length-1},getText:function(t){return this._elements[t]},removeText:function(t){this._elements.length>t&&(document.body.removeChild(this._elements[t]),this._elements.splice(t,1))},createStageText:function(t,e){var i=this.createText(""+t+" - "+e,"50%","50%",{transform:"translateX(-50%)",fontSize:"22pt",webkitTouchCallout:"none",webkitUserSelect:"none",mozUserSelect:"none",msUserSelect:"none",userSelect:"none"}),n=this._elements[i];n.style.opacity=0;var o=setInterval(function(){n.style.opacity-=-.06,n.style.opacity>=1&&(setTimeout(function(){var t=setInterval(function(){n.style.opacity-=.06,n.style.opacity<=0&&(l.removeText(i),clearInterval(t))},16)},2e3),clearInterval(o))},16);return i}},u={_frameSkip:0,_maxFrameSkip:0,_fpsMeter:null,initialize:function(t){null!==t&&void 0!==t&&e(t,"boolean","showMeter"),this._fpsMeter=new FPSMeter({theme:"transparent",heat:!0,graph:!0}),t||this._fpsMeter.hide()},measure:function(t){e(t,"function","callback");var i=performance.now();t.call(),this._fpsMeter.tick(),this._frameSkip+=(i-performance.now())/16},needsSkip:function(){return Math.floor(this._frameSkip%this._maxFrameSkip)>0},skipped:function(){this._frameSkip--}},_=t(null,{initialize:function(t,i,n,o){if(e(t,"number","x"),e(t,"number","y"),e(t,"number","w"),e(t,"number","h"),0>=n)throw new Error("A largura da hitbox deve ser maior que zero");if(0>=o)throw new Error("A altura da hitbox deve ser maior que zero");this._x=t,this._y=i,this._w=n,this._h=o},collidesWith:function(t){return i(t,_,"other"),this.left<t.right&&this.right>t.left&&this.top<t.bottom&&this.bottom>t.top}},{x:{get:function(){return this._x},set:function(t){e(t,"number","value"),this._x=t}},y:{get:function(){return this._y},set:function(t){e(t,"number","value"),this._y=t}},width:{get:function(){return this._w},set:function(t){if(e(t,"number","value"),0>t)throw new Error("A largura deve ser maior que zero");this._w=t,this.x=this._x}},height:{get:function(){return this._h},set:function(t){if(e(t,"number","value"),0>t)throw new Error("A altura deve ser maior que zero");this._h=t,this.y=this._y}},left:{get:function(){return this._x-this._w/2},set:function(t){this.x=t+this._w/2}},right:{get:function(){return this._x+this._w/2},set:function(t){this.x=t-this._w/2}},top:{get:function(){return this._y-this._h/2},set:function(t){this.y=t+this._h/2}},bottom:{get:function(){return this._y+this._h/2},set:function(t){this.y=t-this._h/2}}}),f=t(null,{_color:null,initialize:function(t,e,n){this._hitbox=new _(t,e,1,1),"string"==typeof n&&(n=h.movement(n)),i(n,g,"movement"),this._movement=n.bind(this)},update:function(){this._movement.update(),this._movement.apply(),this._checkDispose()},_checkDispose:function(){this.hitbox.x.between(0,a.width-1)&&this.hitbox.y.between(0,a.height-1)||this.dispose()},dispose:function(){h.remove(this)}},{hitbox:{get:function(){return this._hitbox},set:function(t){i(t,_,"value"),this._hitbox=t}},color:{get:function(){return this._color?this._color:this instanceof y?h.currentStage.playerColor:this instanceof v?h.currentStage.enemyColor:this instanceof p&&this._shooter instanceof y?h.currentStage.playerProjectileColor:this instanceof p&&this._shooter instanceof v?h.currentStage.enemyProjectileColor:void 0},set:function(t){e(t,"number","value"),this._color=t}},movement:{get:function(){return this._movement},set:function(t){i(t,g,"value"),this._movement=t.bind(this)}}}),d=t(null,{initialize:function(t,i){e(t,"number","module"),e(i,"number","module"),this._module=t,this._angle=i,this._x=t*Math.cos(i),this._y=t*Math.sin(i)},apply:function(t){i(t,f,"object"),t.hitbox.x+=this._x,t.hitbox.y+=this._y}},{x:{get:function(){return this._x},set:function(t){e(t,"number","value"),this._x=t}},y:{get:function(){return this._y},set:function(t){e(t,"number","value"),this._y=t}},module:{get:function(){return this._module},set:function(t){e(t,"number","value"),this.initialize(t,this.angle)}},angle:{get:function(){return this._angle},set:function(t){e(t,"number","value"),this.initialize(this.module,t)}}}),m=t(null,{_object:null,initialize:function(){throw new Error("`Bindable' é uma classe abstrata")},_initialize:function(){},bind:function(t){var e=this.clone();return e._object=t,e}}),g=t(m,{_onUpdateSrc:null,_onUpdate:null,initialize:function(t){this.__super__._initialize.call(this),t&&(i(t,Array),this._velocities=t)},update:function(){if(!this._object)throw new Error("Não é possível atualizar o movimento antes de ligá-lo a um objeto");this._onUpdate&&this._onUpdate()},bind:function(t){var e=this.__super__.bind.call(this,t);return this._onUpdateSrc&&(e.onUpdate=this._onUpdateSrc),e},apply:function(){for(var t=0;t<this._velocities.length;t++)this._velocities[t].apply(this._object)}},{onUpdate:{get:function(){return this._onUpdate},set:function(t){e(t,"function","value"),this._onUpdateSrc=t,this._onUpdate=t.bind(this)}}}),b=t(g,{update:function(){if(!this._object)throw new Error("Não é possível atualizar o movimento antes de ligá-lo a um objeto");this._clock++},bind:function(t){var e=m.prototype.bind.call(this,t);return e._clock=0,e._x0=t.hitbox.x,e._y0=t.hitbox.y,e},apply:function(){for(var t=0,e=0,i=0;i<this._velocities.length;i++)t+=this._velocities[i].x*this._clock,e+=this._velocities[i].y*this._clock;this._object.hitbox.x=this._x0+t,this._object.hitbox.y=this._y0+e}},{onUpdate:{get:function(){return null},set:function(t){throw new Error("`LinearMovement' não pode ter seu `onUpdate' alterado")}}}),p=t(f,{initialize:function(t,e,n,o){i(o,f,"shooter"),this._shooter=o,this.__super__.initialize.call(this,t,e,n),this._hitbox.width=this._hitbox.height=6}},{shooter:{get:function(){return this._shooter}}}),v=t(f,{initialize:function(t,n,o,r,s){this.__super__.initialize.call(this,t,n,o),this._hitbox.width=this._hitbox.height=10,e(r,"number","health"),e(s,"string","actions"),s=h.actionPattern(s),i(s,x,"actions"),this._maxHealth=r,this._health=r,this._actions=s.bind(this),this._actions.on("initialize")()},applyDamage:function(){this._health--,(this._actions.on("damage")||function(){})(),this._checkDeath()},_checkDeath:function(){this._health<=0&&this._actions.on("death")()},update:function(){this.__super__.update.call(this),h.forEachObject(function(t){t instanceof p&&t.shooter instanceof y&&t.hitbox.collidesWith(this._hitbox)&&(t.dispose(),this.applyDamage())}.bind(this)),this._actions.on("update")()}},{health:{get:function(){return this._health}},maxHealth:{get:function(){return this._maxHealth}}}),x=t(m,{initialize:function(t){this.__super__._initialize.call(this),e(t,"object","events"),this._events=t},bind:function(t){var e=this.__super__.bind.call(this,t);for(var i in e._events)e._events[i]=e._events[i].bind(t);return e},on:function(t){return this._events[t]}}),y=t(f,{_fireTimer:0,initialize:function(t,e){this.__super__.initialize.call(this,t,e,"player"),this._hitbox.width=this._hitbox.height=8},update:function(){this.__super__.update.call(this),this._hitbox.left<0&&(this._hitbox.left=0),this._hitbox.right>a.width&&(this._hitbox.right=a.width),this._hitbox.top<0&&(this._hitbox.top=0),this._hitbox.bottom>a.height&&(this._hitbox.bottom=a.height),r.actionPressed()?(this._fireTimer%=6,0==this._fireTimer++&&h.createProjectile(this.hitbox.x,this.hitbox.y,"straightUp",this)):this._fireTimer>0&&(this._fireTimer=0),h.forEachObject(function(t){(t instanceof p&&t.shooter instanceof v||t instanceof v)&&t.hitbox.collidesWith(this._hitbox)&&(a.invertColors(),h._stop=!0,setTimeout(function(){a.invertColors(),h.restart()},500))}.bind(this))},_checkDispose:function(){}});h.createMovement("static",[]),h.createLinearMovement("straightUp",[new d(8,-Math.PI/2)]),h.createLinearMovement("straightDown",[new d(3,Math.PI/2)]),h.createLinearMovement("straightUp2",[new d(6,-Math.PI/2)]),h.createLinearMovement("straightDown2",[new d(6,Math.PI/2)]),h.createMovement("straightLeft",[new d(4,Math.PI)]),h.createLinearMovement("straightRight",[new d(4,0)]),h.createMovement("straightLeft2",[new d(6,Math.PI)]),h.createLinearMovement("straightRight2",[new d(6,0)]),h.createMovement("rightLeft",[new d(4,0)],function(){this._timer||(this._timer=0),this._timer++,this._timer%=90,0==this._timer&&(this._velocities[0].angle+=Math.PI)}),h.createMovement("leftRight",[new d(4,Math.PI)],function(){this._timer||(this._timer=0),this._timer++,this._timer%=90,0==this._timer&&(this._velocities[0].angle+=Math.PI)}),h.createMovement("circleRight",[new d(2,0)],function(){this._velocities[0].angle+=.1}),h.createMovement("circleLeft",[new d(2,-Math.PI)],function(){this._velocities[0].angle-=.1}),h.createMovement("circleRightLeft",[new d(2,0)],function(){this._dir||(this._dir=1),this._velocities[0].angle+=.1*this._dir,(this._velocities[0].angle>=2*Math.PI||this._velocities[0].angle<=2*-Math.PI)&&(this._dir*=-1)}),h.createMovement("spiralUp",[new d(4,0),new d(4,-Math.PI/2)],function(){this._velocities[0].angle+=.1}),h.createMovement("spiralDown",[new d(4,Math.PI),new d(4,Math.PI/2)],function(){this._velocities[0].angle-=.1}),h.createMovement("spiralRight",[new d(4,0),new d(8,0)],function(){this._velocities[0].angle-=.1}),h.createMovement("spiralLeft",[new d(4,Math.PI),new d(8,Math.PI)],function(){this._velocities[0].angle+=.1}),h.createMovement("spiralDown2",[new d(.75,Math.PI),new d(.75,Math.PI/2)],function(){this._velocities[0].angle-=.1}),h.createMovement("chasePlayer",[new d(4,0)],function(){var t=this._object.hitbox.y-h.player.hitbox.y,e=this._object.hitbox.x-h.player.hitbox.x,i=Math.atan2(t,e);this._velocities[0].angle=i+Math.PI}),h.createMovement("targetPlayer",[new d(4,0)],function(){if(!this._targeted){this._targeted=!0;var t=this._object.hitbox.y-h.player.hitbox.y,e=this._object.hitbox.x-h.player.hitbox.x,i=Math.atan2(t,e);this._velocities[0].angle=i+Math.PI}}),h.createMovement("player",[new d(0,0)],function(){if(isTouchDevice())this._velocities[0].module=s.getModule(2),this._velocities[0].angle=s.getAngle();else{this._velocities[0].module=r.shiftPressed()?1.25:3;var t=[0,3*Math.PI/4,Math.PI/2,Math.PI/4,Math.PI,0,2*Math.PI,5*Math.PI/4,3*Math.PI/2,7*Math.PI/4][r.dir8()];0==t&&(this._velocities[0].module=0),this._velocities[0].angle=t}}),h.createActionPattern("still",{initialize:function(){},update:function(){},death:n}),h.createActionPattern("noexplode",{initialize:function(){},update:function(){},death:function(){this.dispose()}}),h.createActionPattern("straightUp",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&h.createProjectile(this._hitbox.x,this._hitbox.y,"straightUp",this),this._fireTimer++},death:function(){}}),h.createActionPattern("shootPlayer",{initialize:function(){this._timer=0,this._timeouts=[]},update:function(){if(this._timer++,this._timer%60==0&&this._hitbox.y+64<h.player.hitbox.y)for(var t=0;1>t;t++)this._timeouts.push(setTimeout(function(){h.createProjectile(this._hitbox.x,this._hitbox.y,"targetPlayer",this)}.bind(this),200*t+1))},death:function(){for(var t=0;t<this._timeouts.length;t++)clearTimeout(this._timeouts[t]);this.dispose()}}),h.createActionPattern("circle",{initialize:function(){this._fireTimer=0},update:function(){var t=48;if(this._fireTimer%72==0){for(var e=0;t>=e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,2*Math.PI/t*e)]),this);c.playSe("audio/enemyShot01.m4a",.05,.5)}this._fireTimer++},death:n}),h.createActionPattern("circle1",{initialize:function(){this._fireTimer=0},update:function(){var t=24;if(this._fireTimer%72==0){for(var e=0;t>=e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,2*Math.PI/t*e)]),this);c.playSe("audio/enemyShot01.m4a",.05,.5)}this._fireTimer++},death:n}),h.createActionPattern("spiral1",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,2*-Math.PI/240*this._fireTimer)]),this),this._fireTimer++},death:n}),h.createActionPattern("spiral2",{initialize:function(){this._fireTimer=0},update:function(){this._fireTimer%5==0&&h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,2*Math.PI/240*this._fireTimer)]),this),this._fireTimer++},death:n}),h.createActionPattern("arc1",{initialize:function(){this._timer=0},update:function(){var t=10;if(this._timer++%120==0)for(var e=0;t>=e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(1.5-e/t/2,Math.PI/4+Math.PI/4/t*e)]),this);if(this._timer%150==0)for(var e=0;t>=e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(1.5-e/t/2,Math.PI/4+Math.PI/4/t*e)]),this)},death:n}),h.createActionPattern("arc2",{initialize:function(){this._timer=0},update:function(){var t=10;if(this._timer++%120==0)for(var e=0;t>=e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(1+e/t/2,Math.PI/2+Math.PI/4/t*e)]),this);if(this._timer%150==0)for(var e=0;t>=e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(1+e/t/2,Math.PI/2+Math.PI/4/t*e)]),this)},death:n}),h.createActionPattern("boss1",{initialize:function(){this._fireTimer=0,this._deathCount=0,this._positioned=!0},update:function(){var t=this._maxHealth-this._health,e=t/this._maxHealth,i=function(t){for(var e=Math.PI/120*t,i=0;2>i;i++)for(var n=t*i*Math.PI/16,o=[e*this._fireTimer+n,Math.PI/2+e*this._fireTimer+n,Math.PI+e*this._fireTimer+n,1.5*Math.PI+e*this._fireTimer+n],r=0;r<o.length;r++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,o[r])]),this)}.bind(this),n=function(){for(var t=42,e=0;t>e;e++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,2*Math.PI/t*e)]),this);c.playSe("audio/enemyShot01.m4a",.05,.5)}.bind(this);if(this._positioned)switch(this._deathCount){case 1:case 2:if(this._fireTimer%Math.floor(9-2*e)==0&&i(-1),1==this._deathCount){this._fireTimer%120==0&&n();break}case 0:this._fireTimer%Math.floor(9-2*e)==0&&i(1),this._fireTimer%120==0&&n();break;case 3:if(this._fireTimer%1==0)for(var o=0;2>o;o++)h.createProjectile(this._hitbox.x,this._hitbox.y,new g([new d(2,Math.random()*Math.PI*2)]),this)}var r=255,s=255&Math.floor(255-255*e);this._color=(r<<16)+(s<<8)+s,this._fireTimer++},death:function(){switch(this._deathCount++,this._deathCount){case 1:this._positioned=!1,this.movement=new g([new d(4,0)]),this._onPosInterval=setInterval(function(){this.hitbox.x>=2*a.width/3&&(this.movement=h.movement("static"),clearInterval(this._onPosInterval),this._positioned=!0)}.bind(this),10);break;case 2:this.movement=new g([new d(.3,Math.PI)]),this.movement.onUpdate=function(){0==this._velocities[0].angle&&this._object.hitbox.x>=2*a.width/3?this._velocities[0].angle=Math.PI:this._velocities[0].angle==Math.PI&&this._object.hitbox.x<=a.width/3&&(this._velocities[0].angle=0)};break;case 3:this.movement=h.movement("circleRight")}4==this._deathCount?this.dispose():this._health=this._maxHealth}}),h.createActionPattern("boss2",{initialize:function(){this._deathCount=0,this._colors=[16711680,65280,255,16776960,65535,16742144,7799039],this._fireTimer=0,this._health=this._maxHealth/2},update:function(){function t(t,e){if(this._fireTimer%60==0){for(var i=21,n=0;i>n;n++)h.createProjectile(t,e,new g([new d(2,2*Math.PI/i*n)]),this);c.playSe("audio/enemyShot01.m4a",.05,.5)}}function e(t){var e=h.createProjectile(t,0,"straightDown2",this);e.hitbox.height=128}function i(t){var e=h.createProjectile(0,t,"straightRight2",this);e.hitbox.width=128}if(0==this._deathCount){if(Math.floor(this._fireTimer/40)%2==0&&this._fireTimer%3==0){var n=h.createProjectile(this.hitbox.x,this.hitbox.y,"straightDown2",this);n.movement._velocities[0].angle+=this._fireTimer/60*Math.PI*2,n=h.createProjectile(this.hitbox.x,this.hitbox.y,"straightUp2",this),n.movement._velocities[0].angle+=this._fireTimer/60*Math.PI*2,n=h.createProjectile(this.hitbox.x,this.hitbox.y,"straightRight2",this),n.movement._velocities[0].angle+=this._fireTimer/60*Math.PI*2,n=h.createProjectile(this.hitbox.x,this.hitbox.y,"straightLeft2",this),n.movement._velocities[0].angle+=this._fireTimer/60*Math.PI*2}Math.floor(this._fireTimer/15)%3==0&&(h.createProjectile(a.width-this.hitbox.x,0,"straightDown2",this),h.createProjectile(this.hitbox.x,0,"straightDown2",this))}else if(1==this._deathCount){if(Math.floor(this._fireTimer/120)%2==0){var o=Math.random()*a.width;h.createProjectile(o,a.height/6,"targetPlayer",this),h.createProjectile(a.width-o,a.height/6,"targetPlayer",this)}if(Math.floor(this._fireTimer/10)%4==0){var o=Math.random()*a.width;h.createProjectile(o,a.height/8,"targetPlayer",this),h.createProjectile(a.width-o,a.height/8,"targetPlayer",this)}}else if(2==this._deathCount){if(this._fireTimer%20==0){var o=Math.random()*a.width,r=Math.random()*a.height;e.call(this,o),i.call(this,r)}t.call(this,this.hitbox._x,this.hitbox._y)}else 3==this._deathCount&&this._fireTimer%2==0&&this._fireTimer%210<120&&(h.createProjectile(0,0,"targetPlayer",this),h.createProjectile(a.width,a.height,"targetPlayer",this),h.createProjectile(0,a.height,"targetPlayer",this),h.createProjectile(a.width,0,"targetPlayer",this));this._fireTimer++},death:function(){switch(this._deathCount++,this._deathCount){case 1:this._positioned=!1,this.movement=new g([new d(4,-Math.PI/2)]),this._onPosInterval=setInterval(function(){this.hitbox.y<=a.width/6&&(this.movement=h.movement("static"),clearInterval(this._onPosInterval),this._positioned=!0)}.bind(this),10),this._onSzInterval=setInterval(function(){this.hitbox.width<=24?clearInterval(this._onSzInterval):this.hitbox.width=--this.hitbox.height;
}.bind(this),24),this._health=this._maxHealth;break;case 2:this._onSzInterval=setInterval(function(){this.hitbox.width>=12?clearInterval(this._onSzInterval):this.hitbox.width=++this.hitbox.height}.bind(this),24),this.movement=h.movement("circleRightLeft"),this._health=this._maxHealth;break;case 3:this._onSzInterval=setInterval(function(){this.hitbox.width>=32?clearInterval(this._onSzInterval):this.hitbox.width=++this.hitbox.height}.bind(this),16),this.movement=h.movement("static"),this._health=50}4==this._deathCount&&this.dispose()}}),h.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,bgm:["audio/badapple.mp3"],initialize:function(t){t?e(t,"boolean","text"):l.createStageText(h.currentStageID,"Yet Another Bullet Hell");var i=h.createEnemy(a.width/2,128,"static",40,"circle1");this._i1=setInterval(function(){if(!(i.health<=0)){h.createEnemy(Math.random()*a.width,0,new g([new d(3,Math.random()*Math.PI/4+Math.PI/4)]),1,"shootPlayer")}},1e3)},terminate:function(){clearInterval(this._i1)}}),h.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,bgm:["audio/badapple.mp3"],initialize:function(t){t?e(t,"boolean","text"):l.createStageText(h.currentStageID,"Shooting Star"),this._enemies=h.createEnemies([a.width/6,32,"static",15,"arc1"],[5*a.width/6,32,"static",15,"arc2"]),this._i1=setInterval(function(){this._enemies.some(function(t){return t.health>0})&&h.createEnemy(a.width-1,64*Math.random()+32,"straightLeft",1,"spiral2")}.bind(this),3e3),this._i2=setInterval(function(){this._enemies.some(function(t){return t.health>0})&&h.createEnemy(1,64*Math.random()+32,"straightRight",1,"spiral2")}.bind(this),6e3)},terminate:function(){clearInterval(this._i1),clearInterval(this._i2)}}),h.createStage({backgroundColor:0,playerColor:65280,enemyColor:16711680,playerProjectileColor:65535,enemyProjectileColor:16776960,bgm:["audio/megalovania.mp3"],initialize:function(t){t?e(t,"boolean","text"):l.createStageText("BOSS","Starry Night");var i=h.createEnemy(a.width/3,96,"static",60,"boss1");i.hitbox.width=i.hitbox.height=16,i.color=16777215},terminate:function(){}}),h.createStage({backgroundColor:16777215,playerColor:43775,enemyColor:0,playerProjectileColor:65280,enemyProjectileColor:16711680,bgm:["audio/tetris.mp3"],initialize:function(t){t?e(t,"boolean","text"):l.createStageText(h.currentStageID,"Holy Trinity"),this._enemies=h.createEnemies([a.width/3,96,"static",5,"circle1"],[2*a.width/3,96,"static",5,"circle1"],[a.width/2,192,"static",5,"circle1"]),this._i1=setInterval(function(){this._enemies.some(function(t){return t.health>0})&&h.createEnemy(0,32,"circleRight",10,"arc1")}.bind(this),2e3),this._i2=setInterval(function(){this._enemies.some(function(t){return t.health>0})&&h.createEnemy(a.width-1,32,"circleLeft",10,"arc2")}.bind(this),3e3)},terminate:function(){clearInterval(this._i1),clearInterval(this._i2)}}),h.createStage({backgroundColor:16777215,playerColor:43775,enemyColor:0,playerProjectileColor:65280,enemyProjectileColor:16711680,bgm:["audio/tetris.mp3"],initialize:function(t){t?e(t,"boolean","text"):l.createStageText(h.currentStageID,"Spirals"),this._touts=[],this._e=h.createEnemy(a.width/5,32,"rightLeft",10,"spiral1"),this._i1=setInterval(function(){this._e.health<=0||(h.createEnemy(64,a.height-64,"spiralUp",5,"circle1"),this._touts.push(setTimeout(function(){h.createEnemy(a.width-64,64,"spiralDown",5,"circle1")},1e3)))}.bind(this),3e3)},terminate:function(){clearInterval(this._i1);for(var t=0;t<this._touts.length;t++)clearTimeout(this._touts[t])}}),h.createStage({backgroundColor:16777215,playerColor:43775,enemyColor:0,playerProjectileColor:65280,enemyProjectileColor:16711680,bgm:["audio/unowenwasher.mp3",.8],initialize:function(t){t?e(t,"boolean","text"):l.createStageText("BOSS","There Will Be Blood"),this._boss=h.createEnemy(a.width/6,a.height/3,"rightLeft",36,"boss2"),this._boss.hitbox.width=this._boss.hitbox.height=32,this._colors=[16711680,65280,255,16776960,65535,16742144,7799039],this._tetrisInterval=null},startTetris:function(){this._tetrisInterval&&this.endTetris();var t=function(){if(!(this._boss.health<=0)){var t=Math.random(),e=this._colors[Math.floor(t*this._colors.length)],i=Math.floor(Math.random()*a.width)/12,n=function(t,i){var n=new v(12*t,12*i,"straightDown",12,"noexplode");n.color=e,n.hitbox.width=n.hitbox.height=12,h.add(n)};switch(Math.floor(7*t)){case 0:n(i-2,0),n(i-1,0),n(i,0),n(i+1,0);break;case 1:n(i-1,0),n(i-1,1),n(i,1),n(i+1,1);break;case 2:n(i+1,0),n(i-1,1),n(i,1),n(i+1,1);break;case 3:n(i-1,0),n(i,0),n(i-1,1),n(i,1);break;case 4:n(i,0),n(i+1,0),n(i-1,1),n(i,1);break;case 5:n(i,0),n(i-1,1),n(i,1),n(i+1,1);break;case 6:n(i-1,0),n(i,0),n(i,1),n(i+1,1)}}}.bind(this);this._tetrisInterval=setInterval(t,75)},endTetris:function(){clearInterval(this._tetrisInterval),this._tetrisInterval=null},terminate:function(){this.endTetris()}}),h.createStage({backgroundColor:0,playerColor:16777215,enemyColor:0,playerProjectileColor:16711680,enemyProjectileColor:0,bgm:["audio/badapple.mp3"],initialize:function(t){var e=h.createEnemy(0,0,"static",1,"noexplode");e.hitbox.width=e.hitbox.height=0;var i=l.createText("Yet Another Bullet Hell","50%","50%",{transform:"translateX(-50%) translateY(-50%)",fontSize:"32pt",opacity:1}),n=l.getText(i);setTimeout(function(){var t=setInterval(function(){if(n.style.opacity-=.06,n.style.opacity<=0){l.removeText(i),clearInterval(t),i=l.createText("<strong>Programação</strong><br>Guilherme Guidotti Brandt","50%","50%",{transform:"translateX(-50%) translateY(-50%)",fontSize:"24pt",textAlign:"center",opacity:0}),n=l.getText(i);var o=setInterval(function(){n.style.opacity-=-.06,n.style.opacity>=1&&(setTimeout(function(){var t=setInterval(function(){n.style.opacity-=.06,n.style.opacity<=0&&(l.removeText(i),clearInterval(t),i=l.createText('<strong>Música</strong><br>Bad Apple & U.N. Owen Was Her ~ 東方 (Touhou), ZUN<br>Tetris Type-A ~ Tetris<br>Megalovania ~ Undertale, Toby "Radiation" Fox',"50%","50%",{transform:"translateX(-50%) translateY(-50%)",fontSize:"24pt",textAlign:"center",opacity:0}),n=l.getText(i),o=setInterval(function(){n.style.opacity-=-.06,n.style.opacity>=1&&(setTimeout(function(){t=setInterval(function(){n.style.opacity-=.06,n.style.opacity<=0&&(l.removeText(i),clearInterval(t),e.dispose())},16)},6e3),clearInterval(o))},16))},16)},4e3),clearInterval(o))},16)}},16)},2e3)},terminate:function(){}}),a.initialize(),c.initialize(),l.initialize(),u.initialize(),h.start(),isTouchDevice()&&s.initialize();var w=!1;o()}();